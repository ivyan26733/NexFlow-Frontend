# CI/CD: Run CI on every push/PR to master; deploy to Vercel on push to master only.
name: CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # Job 1: Type-check and build to ensure the app compiles and tests pass.
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      # Checkout the repo so we can run install and build.
      - name: Checkout code
        uses: actions/checkout@v4

      # Use Node 20 and cache npm to speed up installs.
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Install exact versions from package-lock.json for reproducible CI.
      - name: Install dependencies
        run: npm ci

      # Fail the pipeline if TypeScript has type errors (catches bugs before deploy).
      - name: TypeScript type check
        run: npx tsc --noEmit

      # Ensure the Next.js production build succeeds before we allow deploy.
      - name: Build
        run: npm run build

  # Job 2: Deploy to Vercel production only on push to main (not on PRs).
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push'
    steps:
      # Checkout the same commit that passed CI so we deploy that exact code.
      - name: Checkout code
        uses: actions/checkout@v4

      # Vercel CLI is required to pull env, build, and deploy from the workflow.
      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      # Pull production env and project config from Vercel so build/deploy use the right settings.
      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      # Build the app with Vercel's build pipeline (uses NEXT_PUBLIC_* from Vercel env).
      - name: Build with Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      # Deploy the pre-built output to Vercel production; org and project IDs are required by the CLI.
      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
